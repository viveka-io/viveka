<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>DIFFY</title>
    <meta name="description" content="">
    <style>
        html,body {
            margin: 0;
            padding: 0;
        }
        body {
            background: #fff;
            font: normal 16px/1 Tahoma, sans-serif;
        }

        button {
            background: #ddd;
            border: 0;
            border-radius: 5px;
            padding: 10px;
            font-weight: bold;
            box-shadow: 0 0 2px rgba(0,0,0,.5), inset 0 1px 0 rgba(0,0,0,.1);
            outline: 0;
            margin: 0 5px;
        }

        button[data-pushed="true"] {
            box-shadow: 0 2px 2px rgba(0,0,0,.5);
            background: #ccc;
        }
        button[data-pushed="true"] i {
            background: transparent!important;
        }

        button i {
            display: inline-block;
            border-radius: 100%;
            border: 1px solid #666;
            width: 1em;
            height: 1em;
            margin-right: 5px;
            vertical-align: bottom;
            line-height: 0;
        }

        img {
            width: 100%;
            vertical-align: top;
        }

        .container {
            width:46%;
            margin: 2%;
            position: relative;
            float: left;
        }

        .buttons {
            text-align: center;
            padding: 10px;
        }

        .diff {
            position: absolute;
            outline: 1px dotted rgba(0,0,0,.2);
            box-sizing: border-box;
        }

        .diff * {
            position: absolute;
            left:0; top: 0; right: 0; bottom: 0;
            box-sizing: border-box;
        }

        button.node_removed i       { background: rgba(255,0,0,.2); }
        button.node_added i         { background: rgba(0,255,0,.2); }
        button.not_matching_name i  { background: rgba(255,255,0,.2); }
        button.not_matching_hash i  { background: rgba(0,0,255,.2); }


        .node_removed .node_removed                     { background: rgba(255,0,0,.2); }
        .node_added .node_added                         { background: rgba(0,255,0,.2); }
        .not_matching_name .not_matching_name span      { background: rgba(255,255,0,.2); }
        .not_matching_hash .not_matching_hash b         { background: rgba(0,0,255,.2); }
        .offset_width .offset_width_lower               { border-right: 5px solid rgba(255,0,0,.2); }
        .offset_width .offset_width_higher              { border-right: 5px solid rgba(0,255,0,.2); }
        .offset_height .offset_height_lower             { border-bottom: 5px solid rgba(255,0,0,.2);}
        .offset_height .offset_height_higher            { border-bottom: 5px solid rgba(0,255,0,.2);}
        .offset_x .offset_x_lower:after,
        .offset_x .offset_x_higher:after,
        .offset_x .offset_y_lower:after,
        .offset_x .offset_y_higher:after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            transform: translate(-50%, -50%);
        }
        .offset_x .offset_x_lower:after                 { left: 0; top: 50%; border-right-color: rgba(0,0,0,.4); margin-left: -10px;}
        .offset_x .offset_x_higher:after                { left: 0; top: 50%; border-left-color: rgba(0,0,0,.4); }
        .offset_y .offset_y_lower:after                 { left: 50%; top: 0; border-bottom-color: rgba(0,0,0,.4); margin-top: -10px; }
        .offset_y .offset_y_higher:after                { left: 50%; top: 0; border-top-color: rgba(0,0,0,.4); }


    </style>
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script>
        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function getDiffs(idA, idB) {
            var $A      = $('#contA'),
                $B      = $('#contB'),
                $imgA   = $('#imgA'),
                $imgB   = $('#imgB'),
                ratioA = $imgA.width() / $imgA[0].naturalWidth,
                ratioB = $imgB.width() / $imgB[0].naturalWidth;

            $.ajax({
                url: '/differences-json/' + idA + '/' + idB,
                success: function(data) {
                    $(data).each(function(index, item) {
                        var area,
                            classNames = item.differences.join(' ').toLowerCase();

                        if (item.a) {
                            area = $('<div title="' + item.a.name + '" class="diff ' + classNames + '"><span><b><i></i></b></span></div>').appendTo($A);
                            area.css({
                                top: item.a.offset.top * ratioA,
                                left: item.a.offset.left * ratioA,
                                width: item.a.offset.width * ratioA,
                                height: item.a.offset.height * ratioA
                            });
                        }
                        if (item.b) {
                            area = $('<div title="' + item.b.name + '" class="diff ' + classNames + '"><span><b><i></i></b></span></div>').appendTo($B);
                            area.css({
                                top: item.b.offset.top * ratioB,
                                left: item.b.offset.left * ratioB,
                                width: item.b.offset.width * ratioB,
                                height: item.b.offset.height * ratioB
                            });
                        }
                    });
                }
            });
        }

        $(function(){

            var $imgA   = $('#imgA'),
                $imgB   = $('#imgB'),
                idA     = getParameterByName('a'),
                idB     = getParameterByName('b'),
                loaded  = 0;

            $imgA.one('load', function() {
                    loaded++;
                    if (loaded == 2) getDiffs(idA, idB);
                })
                .attr('src', '/images/fingerprints/' + idA + '.png')
                .each(function() {
                    //Cache fix for browsers that don't trigger .load()
                    if(this.complete) $(this).trigger('load');
                });
            $imgB.one('load', function() {
                    loaded++;
                    if (loaded == 2) getDiffs(idA, idB);
                })
                .attr('src','/images/fingerprints/' + idB + '.png')
                .each(function() {
                    //Cache fix for browsers that don't trigger .load()
                    if(this.complete) $(this).trigger('load');
                });

            $('button').on('click', function() {
                var $button = $(this),
                    $class = $button.attr('class'),
                    isDisabled = $button.attr('data-pushed') === "true";

                $button.attr('data-pushed', !isDisabled);

                $('#wrapper').toggleClass($class);

                return false;
            });

        });
    </script>
</head>
<body>

    <div class="buttons">
        <button class="node_removed"><i></i>Removed</button>
        <button class="node_added"><i></i>Added</button>
        <button class="not_matching_name"><i></i>Name</button>
        <button class="not_matching_hash"><i></i>Hash</button>
        <button class="offset_width"><i></i>Width</button>
        <button class="offset_height"><i></i>Height</button>
        <button class="offset_x"><i></i>Left</button>
        <button class="offset_y"><i></i>Top</button>
    </div>

    <div id="wrapper" class="node_removed node_added not_matching_name not_matching_hash offset_width offset_height offset_x offset_y">
        <div class="container" id="contA">
            <img id="imgA">
        </div>
        <div class="container" id="contB">
            <img id="imgB">
        </div>
    </div>

</body>
</html>
